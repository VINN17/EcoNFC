<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Device Config - NFC Setup</title>
  <style>
    :root{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif}
    body{padding:18px;max-width:800px;margin:0 auto;background:#f6f8fa;color:#111}
    h1{font-size:20px;margin-bottom:6px}
    p.lead{color:#444;margin-bottom:18px}
    .card{background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06);padding:16px;margin-bottom:16px}
    label{display:block;font-size:13px;margin-top:10px}
    input[type=text], input[type=password], input[type=number], textarea, select{width:100%;padding:10px;border:1px solid #e6e9ee;border-radius:8px;margin-top:6px;font-size:14px}
    button{padding:10px 12px;border-radius:8px;border:none;background:#0b63d6;color:#fff;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:#0b63d6;border:1px solid #dbeafe}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .muted{color:#666;font-size:13px}
    pre{background:#0f1724;color:#e6eef8;padding:10px;border-radius:8px;overflow:auto}
    .small{font-size:13px}
    .inline{display:inline-block}
    .status-ok{color:green}
    .status-warn{color:orange}
    .status-err{color:red}
    .hint{font-size:13px;color:#666;margin-top:8px}
  </style>
</head>
<body>
  <h1>Konfigurasi Device (NFC)</h1>
  <p class="lead">Gunakan tombol <strong>Detect NFC</strong> untuk meminta ESP membaca tag via PN532, lalu atur WiFi, MQTT, dan Device ID.</p>

  <div class="card">
    <strong>Langkah 1 — Detect NFC</strong>
    <p class="muted">Tempelkan HP pada modul NFC. ESP akan mencoba membaca UID tag dan mengembalikannya ke halaman ini.</p>
    <div style="margin-top:10px">
      <button id="btnDetect">Detect NFC</button>
      <span id="nfcResult" class="muted" style="margin-left:12px">Belum terdeteksi</span>
    </div>
    <div class="hint">Catatan: endpoint yang dipanggil: <code>GET /nfc/detect</code>. ESP harus mengembalikan JSON {"ok":true,"uid":"AB:CD:12:34"} atau {"ok":false,"error":"..."}.</div>
  </div>

  <form id="cfgForm" onsubmit="return false;">
    <div class="card">
      <strong>Langkah 2 — Device & Jaringan</strong>
      <label>Device ID (UID dari NFC, bisa diganti)</label>
      <input type="text" id="deviceId" placeholder="ex: device-ABCD1234" />

      <label>WiFi SSID</label>
      <input type="text" id="ssid" placeholder="Nama WiFi" />

      <label>WiFi Password</label>
      <input type="password" id="wifipass" placeholder="Password WiFi" />

      <label>Static IP (opsional)</label>
      <input type="text" id="staticIp" placeholder="192.168.1.50 atau kosong" />

      <label>Gateway (opsional)</label>
      <input type="text" id="gateway" placeholder="192.168.1.1" />

      <label>Netmask (opsional)</label>
      <input type="text" id="netmask" placeholder="255.255.255.0" />

      <div style="margin-top:12px" class="row">
        <div class="col">
          <label>MQTT Broker</label>
          <input type="text" id="mqttBroker" placeholder="mqtt.example.com" />
        </div>
        <div class="col">
          <label>MQTT Port</label>
          <input type="number" id="mqttPort" value="1883" />
        </div>
      </div>

      <label>MQTT Topic (publish)</label>
      <input type="text" id="mqttTopic" placeholder="devices/{deviceId}/data" />

      <label>Publish Interval (detik)</label>
      <input type="number" id="interval" value="60" />

      <div style="margin-top:12px">
        <button id="btnSave">Simpan & Apply</button>
        <button id="btnSaveOnly" class="ghost" style="margin-left:8px">Simpan saja</button>
        <button id="btnTest" class="ghost" style="margin-left:8px">Test Koneksi MQTT</button>
      </div>

      <div id="saveResult" class="hint"></div>
    </div>
  </form>

  <div class="card">
    <strong>Status Device</strong>
    <div style="margin-top:10px">
      <button id="btnRefresh">Refresh Status</button>
      <div id="deviceStatus" style="margin-top:10px" class="small">-</div>
      <div class="hint">Endpoint status: <code>GET /status</code> mengembalikan JSON status jaringan & sensor.</div>
    </div>
  </div>

  <div class="card">
    <strong>Log / Debug</strong>
    <pre id="logArea">-- ready --</pre>
  </div>

  <script>
    const log = (...args) => {
      const p = document.getElementById('logArea');
      const t = new Date().toLocaleTimeString();
      p.textContent = [t, ...args].join(' ') + '\n' + p.textContent;
    };

    // Utility: fetch JSON with timeout
    async function fetchJson(path, opts = {}){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), 12000);
      try{
        const res = await fetch(path, {...opts, signal: controller.signal});
        clearTimeout(id);
        const txt = await res.text();
        try{ return JSON.parse(txt); }catch(e){ return {ok:false, raw:txt}; }
      }catch(e){ clearTimeout(id); return {ok:false, error: e.message}; }
    }

    // NFC Detect
    document.getElementById('btnDetect').addEventListener('click', async ()=>{
      log('requesting /nfc/detect...');
      document.getElementById('nfcResult').textContent = 'Mencoba...';
      const r = await fetchJson('/nfc/detect');
      if(r && r.ok){
        document.getElementById('nfcResult').textContent = 'UID: ' + r.uid;
        document.getElementById('deviceId').value = r.uid.replace(/[: ]/g,'-').toLowerCase();
        log('nfc uid', r.uid);
      }else{
        document.getElementById('nfcResult').textContent = 'Gagal: ' + (r.error || (r.raw||'unknown'));
        log('nfc failed', r);
      }
    });

    // Save config & apply (POST /config)
    async function saveConfig(apply){
      const body = {
        deviceId: document.getElementById('deviceId').value,
        wifi: {ssid:document.getElementById('ssid').value, pass:document.getElementById('wifipass').value},
        network: {ip:document.getElementById('staticIp').value || null, gateway:document.getElementById('gateway').value || null, netmask:document.getElementById('netmask').value || null},
        mqtt: {broker:document.getElementById('mqttBroker').value, port:parseInt(document.getElementById('mqttPort').value||1883), topic:document.getElementById('mqttTopic').value},
        interval: parseInt(document.getElementById('interval').value||60),
        apply: !!apply
      };
      log('posting /config', body);
      const r = await fetchJson('/config', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      if(r && r.ok){
        document.getElementById('saveResult').textContent = 'Sukses: ' + (r.message || 'tersimpan');
        log('config ok', r);
      }else{
        document.getElementById('saveResult').textContent = 'Gagal: ' + (r.error || r.raw || 'unknown');
        log('config failed', r);
      }
    }

    document.getElementById('btnSave').addEventListener('click', ()=>saveConfig(true));
    document.getElementById('btnSaveOnly').addEventListener('click', ()=>saveConfig(false));

    // Test MQTT connection via ESP endpoint
    document.getElementById('btnTest').addEventListener('click', async ()=>{
      const payload = {broker:document.getElementById('mqttBroker').value, port:parseInt(document.getElementById('mqttPort').value||1883)};
      log('posting /mqtt/test', payload);
      const r = await fetchJson('/mqtt/test', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if(r && r.ok){
        alert('MQTT OK\n'+(r.message||''));
      }else{
        alert('MQTT Gagal\n'+(r.error||r.raw||'unknown'));
      }
    });

    // Status
    async function refreshStatus(){
      log('requesting /status');
      const r = await fetchJson('/status');
      const el = document.getElementById('deviceStatus');
      if(r && r.ok){
        el.innerHTML = `Mode: ${r.mode || '-'}<br>WiFi: ${r.wifi?.connected? 'connected' : 'disconnected'} <br>IP: ${r.network?.ip || '-'}<br>MQTT: ${r.mqtt?.connected? 'connected' : 'disconnected'}<br>Last sensor: ${JSON.stringify(r.lastSensor || {})}`;
        log('status', r);
      }else{
        el.textContent = 'Gagal ambil status: ' + (r.error||r.raw||'unknown');
        log('status failed', r);
      }
    }
    document.getElementById('btnRefresh').addEventListener('click', refreshStatus);

    // Auto refresh status on load
    window.addEventListener('load', ()=>{
      refreshStatus();
    });
  </script>
</body>
</html>
