<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Device NFC Configuration</title>
    <style>
        /* CSS tetap sama seperti sebelumnya */
        /* Salin seluruh CSS dari contoh sebelumnya */
    </style>
</head>
<body>
    <div class="container">
        <!-- Struktur HTML tetap sama seperti sebelumnya -->
        <!-- Salin seluruh struktur HTML dari contoh sebelumnya -->
    </div>

    <script>
        // Konfigurasi Global
        let currentDeviceId = null;
        let nfcSupported = false;
        const CONFIG_VERSION = '1.0.0';

        // Cek Dukungan NFC
        if ('NDEFReader' in window && 'NDEFWriter' in window) {
            nfcSupported = true;
        } else {
            document.getElementById('nfc-button').disabled = true;
            document.getElementById('nfc-button').textContent = '‚ùå NFC Tidak Didukung';
        }

        // Fungsi Utilitas
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // Validasi Konfigurasi
        function validateConfiguration(config) {
            const requiredFields = [
                'deviceName', 'wifiSSID', 'wifiPassword', 
                'serverIP', 'serverPort', 'mqttBroker', 'mqttPort'
            ];

            for (let field of requiredFields) {
                if (!config[field] || config[field].trim() === '') {
                    throw new Error(`Field ${field} tidak boleh kosong`);
                }
            }

            // Validasi tambahan
            if (config.serverPort < 1 || config.serverPort > 65535) {
                throw new Error('Port server tidak valid');
            }
        }

        // Fungsi Menulis Konfigurasi ke NFC
        async function writeConfigToNFC(deviceId, config) {
            try {
                validateConfiguration(config);

                const ndef = new NDEFWriter();
                const configString = JSON.stringify({
                    ...config,
                    version: CONFIG_VERSION,
                    timestamp: Date.now()
                });

                await ndef.write({
                    records: [
                        {
                            recordType: "text",
                            data: `DEVICE:${deviceId}\nCONFIG:${configString}`
                        }
                    ]
                });

                return true;
            } catch (error) {
                console.error('NFC Write Error:', error);
                throw error;
            }
        }

        // Fungsi Membaca Konfigurasi dari NFC
        async function readConfigFromNFC() {
            return new Promise((resolve, reject) => {
                try {
                    const ndef = new NDEFReader();
                    ndef.scan();

                    ndef.addEventListener('reading', ({ message }) => {
                        for (const record of message.records) {
                            if (record.recordType === 'text') {
                                const text = new TextDecoder().decode(record.data);
                                
                                if (text.includes('DEVICE:') && text.includes('CONFIG:')) {
                                    const [devicePart, configPart] = text.split('\nCONFIG:');
                                    const deviceId = devicePart.replace('DEVICE:', '').trim();
                                    
                                    try {
                                        const config = JSON.parse(configPart);
                                        resolve({ deviceId, config });
                                        return;
                                    } catch (parseError) {
                                        reject(new Error('Konfigurasi tidak valid'));
                                    }
                                }
                            }
                        }
                        reject(new Error('Tidak ada konfigurasi ditemukan'));
                    });

                    ndef.addEventListener('readingerror', () => {
                        reject(new Error('Gagal membaca tag NFC'));
                    });

                } catch (error) {
                    reject(error);
                }
            });
        }

        // Event Listener untuk Tombol NFC
        document.getElementById('nfc-button').addEventListener('click', async () => {
            if (!nfcSupported) {
                showStatus('NFC tidak didukung', 'error');
                return;
            }

            try {
                showStatus('Tempelkan tag NFC...', 'info');
                const result = await readConfigFromNFC();
                
                // Isi form dengan konfigurasi yang dibaca
                currentDeviceId = result.deviceId;
                document.getElementById('current-device-id').textContent = currentDeviceId;
                
                // Isi field-field formulir
                Object.keys(result.config).forEach(key => {
                    const element = document.getElementById(key.toLowerCase());
                    if (element) {
                        element.value = result.config[key];
                    }
                });

                showStatus(`Konfigurasi perangkat ${currentDeviceId} berhasil dibaca`, 'success');
            } catch (error) {
                showStatus(error.message, 'error');
            }
        });

        // Event Listener untuk Simpan Konfigurasi
        document.getElementById('device-config-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentDeviceId) {
                showStatus('Pilih atau sambungkan perangkat terlebih dahulu', 'error');
                return;
            }

            // Kumpulkan data konfigurasi
            const config = {
                deviceName: document.getElementById('device-name').value,
                location: document.getElementById('device-location').value,
                wifiSSID: document.getElementById('wifi-ssid').value,
                wifiPassword: document.getElementById('wifi-password').value,
                serverIP: document.getElementById('server-ip').value,
                serverPort: document.getElementById('server-port').value,
                mqttBroker: document.getElementById('mqtt-broker').value,
                mqttPort: document.getElementById('mqtt-port').value,
                mqttTopic: document.getElementById('mqtt-topic').value,
                sensorInterval: document.getElementById('sensor-interval').value,
                sensorType: document.getElementById('sensor-type').value
            };

            try {
                // Tampilkan konfirmasi NFC
                const confirmWrite = confirm('Tempelkan tag NFC untuk menulis konfigurasi');
                
                if (confirmWrite) {
                    await writeConfigToNFC(currentDeviceId, config);
                    showStatus(`Konfigurasi berhasil disimpan ke perangkat ${currentDeviceId}`, 'success');
                }
            } catch (error) {
                showStatus(`Gagal menyimpan: ${error.message}`, 'error');
            }
        });

        // Fungsi Koneksi Manual
        document.getElementById('connect-manual').addEventListener('click', () => {
            const deviceId = document.getElementById('device-uid').value.trim();
            
            if (!deviceId) {
                showStatus('Masukkan ID Perangkat', 'error');
                return;
            }
            
            currentDeviceId = deviceId;
            document.getElementById('current-device-id').textContent = deviceId;
            
            // Tampilkan section konfigurasi
            document.getElementById('connection-section').style.display = 'none';
            document.getElementById('config-section').style.display = 'block';
            
            showStatus(`Terhubung ke perangkat ${deviceId}`, 'success');
        });
    </script>
</body>
</html>
