<script>
    let nfcSupported = false;
    let nfcReader = null;

    // Check NFC support
    if ('NDEFReader' in window) {
        nfcSupported = true;
    }

    const statusDiv = document.getElementById('status');
    const startNfcBtn = document.getElementById('startNfc');
    const configForm = document.getElementById('configForm');
    const saveConfigBtn = document.getElementById('saveConfig');

    // Update status
    function updateStatus(message, type = 'waiting') {
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
    }

    // Generate random device ID
    function generateDeviceId() {
        return 'DEV_' + Math.random().toString(36).substr(2, 8).toUpperCase();
    }

    // Start NFC detection
    startNfcBtn.addEventListener('click', async () => {
        if (!nfcSupported) {
            updateStatus('NFC tidak didukung pada browser ini', 'error');
            return;
        }

        try {
            nfcReader = new NDEFReader();

            startNfcBtn.textContent = 'Mendeteksi NFC...';
            startNfcBtn.disabled = true;

            await nfcReader.scan();
            updateStatus('Siap! Tempel HP ke NFC tag device', 'waiting');

            // Listen for NFC reads
            nfcReader.addEventListener('reading', event => {
                updateStatus('NFC tag terdeteksi! Device terhubung', 'connected');
                configForm.classList.add('show');

                // Auto-generate device ID if empty
                if (!document.getElementById('deviceId').value) {
                    document.getElementById('deviceId').value = generateDeviceId();
                }

                startNfcBtn.style.display = 'none';
            });

            nfcReader.addEventListener('readingerror', () => {
                updateStatus('Error membaca NFC tag', 'error');
            });

        } catch (error) {
            console.error('NFC Error:', error);
            updateStatus('Error: ' + error.message, 'error');
            startNfcBtn.disabled = false;
            startNfcBtn.textContent = 'Mulai Deteksi NFC';
        }
    });

    // Save configuration to NFC
    saveConfigBtn.addEventListener('click', async () => {
        const config = {
            deviceId: document.getElementById('deviceId').value,
            deviceName: document.getElementById('deviceName').value,
            wifiSSID: document.getElementById('wifiSSID').value,
            wifiPassword: document.getElementById('wifiPassword').value,
            serverUrl: document.getElementById('serverUrl').value,
            serverPort: document.getElementById('serverPort').value,
            sensorType: document.getElementById('sensorType').value,
            sendInterval: document.getElementById('sendInterval').value,
            timestamp: new Date().toISOString()
        };

        // Validate required fields
        if (!config.deviceId || !config.wifiSSID || !config.serverUrl) {
            updateStatus('Mohon lengkapi Device ID, WiFi SSID, dan Server URL', 'error');
            return;
        }

        try {
            saveConfigBtn.textContent = 'Tempel HP ke NFC Tag...';
            saveConfigBtn.disabled = true;

            if (nfcReader && nfcSupported) {
                // Create NDEF message with proper formatting
                const configString = JSON.stringify(config);
                const encoder = new TextEncoder();
                const data = encoder.encode(configString);

                // Write to NFC tag
                await nfcReader.write({
                    records: [
                        {
                            recordType: "text", // Store data as text
                            data: configString,
                            encoding: "utf-8",
                            lang: "en"
                        }
                    ]
                });

                updateStatus('✅ Konfigurasi berhasil disimpan ke NFC tag!', 'connected');

                // Vibrate if available
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }

                // Show success message
                setTimeout(() => {
                    updateStatus('Device akan restart dan terhubung ke server', 'connected');
                }, 2000);

            } else {
                throw new Error('NFC tidak tersedia atau browser tidak mendukung penulisan ke NFC tag.');
            }

        } catch (error) {
            console.error('Save Error:', error);
            updateStatus('❌ Error: ' + error.message, 'error');

            // Show detailed error info
            const errorDetails = document.createElement('div');
            errorDetails.innerHTML = `
                <small style="display: block; margin-top: 10px; color: #666;">
                    Pastikan:<br>
                    • NFC diaktifkan di HP<br>
                    • NFC tag dapat ditulis (tidak write-protected)<br>
                    • Tempel HP tepat di atas NFC tag<br>
                    • Gunakan Chrome browser
                </small>
            `;
            statusDiv.appendChild(errorDetails);

        } finally {
            saveConfigBtn.textContent = 'Simpan Konfigurasi ke NFC';
            saveConfigBtn.disabled = false;
        }
    });

    // Show alternative for non-NFC browsers
    if (!nfcSupported) {
        updateStatus('Browser tidak mendukung NFC. Gunakan Chrome di Android.', 'error');
        startNfcBtn.textContent = 'NFC Tidak Tersedia';
        startNfcBtn.disabled = true;

        // Still allow configuration form
        setTimeout(() => {
            configForm.classList.add('show');
            document.getElementById('deviceId').value = generateDeviceId();
            updateStatus('Mode Manual: Isi konfigurasi lalu salin data', 'waiting');
        }, 3000);
    }
</script>
